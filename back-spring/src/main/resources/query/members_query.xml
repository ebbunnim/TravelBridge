<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 

<mapper namespace="com.pjt1.demo.model.dao.MembersDao" >
    <insert id="insert"		parameterType="members">
		INSERT INTO members
		(mem_id, mem_email, 
		mem_phone, 
		mem_name, mem_sex,
		mem_birth, mem_address, 
		mem_grant,
		mem_interest, mem_token, mem_login_type) 
		VALUES (
		#{mem_id:VARCHAR}, #{mem_email:VARCHAR}, 
		#{mem_phone:VARCHAR}, 
		#{mem_name:VARCHAR},#{mem_sex:INTEGER}, 
		#{mem_birth:VARCHAR}, #{mem_address:VARCHAR}, 
		#{mem_grant:INTEGER}, 
		#{mem_interest:VARCHAR}, #{mem_token:VARCHAR}, #{mem_login_type:VARCHAR}
		)
	</insert> 
   	<delete id="delete" 	parameterType="int">
	   UPDATE MEMBERS
	   SET 
	   mem_del_check = true
	   WHERE mem_no = #{mem_no} AND mem_del_check = FALSE
	</delete>
   	<update id="update"		parameterType="members">
		UPDATE members SET
		mem_id=#{mem_id:VARCHAR}, mem_email=#{mem_email:VARCHAR}, 
		mem_phone=#{mem_phone:VARCHAR},
		mem_name=#{mem_name:VARCHAR}, mem_sex=#{mem_sex:INTEGER}, 
		mem_birth=#{mem_birth:VARCHAR}, mem_address=#{mem_address:VARCHAR}, 
		mem_grant= #{mem_grant:INTEGER}, mem_receive_email=#{mem_receive_email:BOOLEAN}, 
		mem_following=#{mem_following:INTEGER}, mem_followed=#{mem_followed:INTEGER},
		mem_lastlogin=CURRENT_TIMESTAMP(), mem_interest=#{mem_interest:VARCHAR}, 
		mem_token=#{mem_token:VARCHAR}, mem_login_type=#{mem_login_type:VARCHAR},
		mem_del_check=#{mem_del_check:BOOLEAN}
		WHERE mem_no = #{mem_no}
	</update>
   	<select id="search"		parameterType="int" resultType="members">
		SELECT * 
		FROM members 
		WHERE mem_no=#{mem_no:INTEGER} 
		AND mem_del_check=false   
	</select>
   	<select id="searchAll"	resultType="members">
		SELECT * 
		FROM members 
		WHERE mem_del_check = false
	</select> 

	<select id="searchMemberByEmail" parameterType="String" resultType="Members">
		SELECT * FROM members WHERE mem_email=#{mem_email:VARCHAR} and mem_del_check=false
	</select>
	<resultMap type="post" id="postMap">
		<result property="post_title" column="post_title"/>
		<result property="post_category" column="post_category"/>
		<result property="post_regtime" column="post_regtime"/>
		<result property="post_city" column="post_city"/>
		<result property="post_hits" column="post_hits"/>
	</resultMap>
	<resultMap type="hotplace" id="hotplaceMap">
		<result property="hp_name" column="hp_name"/>
		<result property="hp_theme" column="hp_theme"/>
		<result property="hp_tag" column="hp_tag"/>
		<result property="hp_address" column="hp_address"/>
		<result property="hp_detail_adr" column="hp_detail_adr"/>
		<result property="hp_content" column="hp_content"/>
		<result property="hp_homepage" column="hp_homepage"/>
		<result property="hp_holiday" column="hp_holiday"/>
		<result property="hp_fee" column="hp_fee"/>
		<result property="hp_img" column="hp_img"/>
	</resultMap>
	<resultMap type="festival" id="festivalMap">
		<result property="fval_name" column="fval_name"/>
		<result property="fval_theme" column="fval_theme"/>
		<result property="fval_tag" column="fval_tag"/>
		<result property="fval_address" column="fval_address"/>
		<result property="fval_detail_adr" column="fval_detail_adr"/>
		<result property="fval_content" column="fval_content"/>
		<result property="fval_homepage" column="fval_homepage"/>
		<result property="fval_start_day" column="fval_start_day"/>
		<result property="fval_end_day" column="fval_end_day"/>
		<result property="fval_fee" column="fval_fee"/>
		<result property="fval_host" column="fval_host"/>
		<result property="fval_img" column="fval_img"/>
		<result property="fval_ended" column="fval_ended"/>
	</resultMap>
	
	<resultMap id="likePostMap" type="Members">
		<id property="mem_id" column="mem_id"/>
		<collection property="mem_likePost" ofType="Post" resultMap="postMap"/>
	</resultMap>
	<resultMap id="likeHotPlaceMap" type="Members">
		<id property="mem_id" column="mem_id"/>
		<collection property="mem_likeHotPlace" ofType="HotPlace" resultMap="hotplaceMap"/>
	</resultMap>
	<resultMap id="likeFestivalMap" type="Members">
		<id property="mem_id" column="mem_id"/>
		<collection property="mem_likeFestival" ofType="Festival" resultMap="festivalMap"/>
	</resultMap>
	
	<select id="searchMemberLikePost" parameterType="int" resultMap="likePostMap">
		SELECT 
		m.mem_id, 
		l.like_no, 
		l.post_no, 
		p.post_title, 
		p.post_category, 
		p.post_regtime, 
		p.post_city, 
		p.post_hits
		FROM members m
		LEFT JOIN likes l ON m.mem_no = l.liker_mem_no AND l.like_del_check=FALSE AND l.like_type = 1
		LEFT JOIN post p ON l.post_no = p.post_no AND p.post_del_check=FALSE
		WHERE m.mem_no = #{mem_no} AND m.mem_del_check = FALSE; 
	</select>
	<select id="searchMemberLikeHotPlace" parameterType="int" resultMap="likeHotPlaceMap">
		SELECT 
		m.mem_id, 
		l.like_no, 
		l.hotplace_no, 
		h.hp_name, 
		h.hp_theme, 
		h.hp_tag, 
		h.hp_address,
		h.hp_detail_adr, 
		h.hp_content,
		h.hp_homepage,
		h.hp_holiday,
		h.hp_fee,
		h.hp_img
		FROM members m
		LEFT JOIN likes l ON m.mem_no = l.liker_mem_no AND l.like_del_check=FALSE AND l.like_type = 2
		LEFT JOIN hotplace h ON l.hotplace_no = h.hp_no AND h.hp_del_check=FALSE
		WHERE m.mem_no = #{mem_no} AND m.mem_del_check = FALSE;
	</select>
	<select id="searchMemberLikeFestival" parameterType="int" resultMap="likeFestivalMap">
		SELECT 
		m.mem_id, 
		l.like_no, 
		l.festival_no, 
		f.fval_name, 
		f.fval_theme, 
		f.fval_tag, 
		f.fval_address,
		f.fval_detail_adr, 
		f.fval_content,
		f.fval_homepage,
		f.fval_start_day,
		f.fval_end_day,
		f.fval_fee,
		f.fval_host,
		f.fval_img,
		f.fval_ended
		FROM members m
		LEFT JOIN likes l ON m.mem_no = l.liker_mem_no AND l.like_del_check=FALSE AND l.like_type = 3
		LEFT JOIN festival f ON l.festival_no = f.fval_no AND f.fval_del_check=FALSE
		WHERE m.mem_no = #{mem_no} AND m.mem_del_check = FALSE; 
	</select>
</mapper>

