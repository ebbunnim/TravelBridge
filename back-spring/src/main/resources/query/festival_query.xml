<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 

<mapper namespace="com.pjt1.demo.model.dao.FestivalDao" >

	<!-- fval_no, fval_del_check defaultë¡œ insert -->
  	<insert id="insert"		parameterType="festival">
		INSERT INTO festival 
		(city_no, fval_name, 
		fval_address, fval_detail_adr,
		fval_content, fval_tag, 
		fval_start_day, fval_end_day, 
		fval_homepage,
		fval_fee, fval_img, 
		fval_host, fval_theme)
		values(
			#{city_no:INTEGER}, #{fval_name:VARCHAR}, 
			#{fval_address:VARCHAR}, #{fval_detail_adr:VARCHAR},
			#{fval_content:VARCHAR}, #{fval_tag:VARCHAR},
			#{fval_start_day:VARCHAR}, #{fval_end_day:VARCHAR},
			#{fval_homepage:VARCHAR},
			#{fval_fee:INTEGER}, #{fval_img:VARCHAR}, 
			#{fval_host:VARCHAR}, #{fval_theme:VARCHAR}
		)	
	</insert> 

   	<delete id="delete" 	parameterType="int">
		UPDATE festival SET fval_del_check = TRUE WHERE fval_no = #{fval_no:INTEGER} AND fval_del_check = FALSE
	</delete>
	<delete id="deleteChildLike" parameterType = "hashmap">
		<choose>
		<when test ="list.size!=0">
			UPDATE likes 
			SET like_del_check = TRUE 
			WHERE like_no in 
			<foreach item = "item" index="index" collection="list" open="(" separator="," close =")">
				#{item}
			</foreach>
		</when>
		<otherwise>
			SELECT 0 FROM DUAL;
		</otherwise>
		</choose>
	</delete> 
	<select id="findChildLike" parameterType = "int" resultType = "likes">
		SELECT like_no
		FROM likes
		WHERE like_type = 3 AND festival_no = #{festival_no:INTEGER} AND like_del_check = FALSE
	</select>
   	<update id="update"		parameterType="festival">
		UPDATE festival 
		SET 
		city_no=#{city_no:INTEGER}, fval_name=#{fval_name:VARCHAR}, 
		fval_address=#{fval_address:VARCHAR}, fval_detail_adr=#{fval_detail_adr:VARCHAR},
		fval_content=#{fval_content:VARCHAR}, fval_tag=#{fval_tag:VARCHAR}, 
		fval_start_day=#{fval_start_day:VARCHAR}, fval_end_day=#{fval_end_day:VARCHAR}, 
		fval_homepage = #{fval_homepage:VARCHAR},
		fval_fee=#{fval_fee:INTEGER}, fval_img= #{fval_map_img:VARCHAR}, 
		fval_host=#{fval_host:VARCHAR}, fval_theme =#{fval_theme:VARCHAR},
		fval_ended=#{fval_ended:BOOLEAN}, fval_del_check=#{fval_del_check:BOOLEAN}
		WHERE fval_no=#{fval_no:INTEGER}
	</update>
   	<select id="search"		parameterType="int" resultType="festival">
		SELECT * 
		FROM festival
		WHERE fval_no=#{fval_no:INTEGER} 
		AND fval_del_check=false   
	</select>
   	<select id="searchAll"	resultType="festival">
		SELECT * 
		FROM festival 
		WHERE fval_del_check=false
	</select>

	<select id="searchMoreFestivalAll" parameterType="int" resultType="festival">
	<![CDATA[
        SELECT * 
        FROM festival 
        WHERE fval_del_check = FALSE 
        ORDER BY fval_no 
        LIMIT 0, #{perPageNum}]]>
	</select>

	<select id ="searchMoreFestivalByCityName" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
        SELECT * 
        FROM festival 
        WHERE fval_del_check = FALSE 
        AND city_no = (SELECT city_no 
						 FROM city 
						 WHERE city_name = "${word}" 
						 AND city_del_check = FALSE) 
        ORDER BY fval_no 
        LIMIT 0, #{perPageNum}]]>
	</select>

	<select id="searchMoreFestivalByTag" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
    	SELECT *
		FROM festival
		WHERE fval_tag LIKE concat('%','${word}','%') 
		AND fval_del_check = FALSE
		ORDER BY fval_no
		LIMIT 0, #{perPageNum}]]>
	</select>
	<select id ="searchMoreFestivalByTheme" parameterType="hashmap" resultType="hashmap">
		SELECT *
		FROM festival
		WHERE fval_del_check = FALSE 
			<if test="filters.size()!=0">
			AND
			<foreach collection="filters" item ="item" index="index" open="(" close=")" separator="or">
				fval_theme like concat('%',#{item},'%')
			</foreach>
			</if>
		ORDER BY fval_no
		LIMIT 0, #{perPageNum}
	</select> 
	<select id ="searchMoreFestival" parameterType="hashmap" resultType="hashmap">
		SELECT *
		FROM festival
		WHERE fval_del_check = FALSE AND
		<choose>
			<when test="searchOption == 'all'">
				(fval_name like concat('%',#{word},'%')
				OR fval_content like concat('%',#{word},'%')
				OR fval_tag like concat('%',#{word},'%'))
			</when> 
			<when test="searchOption == 'title'">
				fval_name like concat('%',#{word},'%')
			</when>
			<when test="searchOption == 'content'">
				fval_content like concat('%',#{word},'%')
			</when>
			<when test="searchOption == 'tag'">
				fval_tag like concat('%',#{word},'%')
			</when>
		</choose>
		ORDER BY fval_no
		LIMIT 0, #{perPageNum}
	</select> 
	
</mapper>

